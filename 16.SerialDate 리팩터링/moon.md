# SerialDate 리팩터링
- 이 장에서는 바로 이 SerialDate라는 클래스를 탐험한다.
- 비판이 있어야 발전이 있다.

## 첫째, 돌려보자
- 테스트 케이스를 훑어보면 모든 경우를 점검하지 않는다.
- 클로버에 따르면 SerialDate에서 실행 가능한 문장 185개 중 실행하는 문장은 50% 였다.
- 그래서 독자는 직접 독자적으로 단위 테스트를 구현했다.
- 소스 코드는 484쪽 목록 B-4를 참조한다.
- SerialDate를 리팩터링 하면서 모든 테스트 케이스를 통과하게 코드를 손볼 작정이다.
#### stringToWeekdayCode메서드 수정
- stringToWeekdayCode라는 메서드는 대소문자 구분 없이 모두 통과해야 한다고 봤다.
- 그래서 equalsIgnoreCase로 바꿔주었다.
- tues와 thurs라는 약어를 지원해야 할지가 분명치 않았기 때문이다.
#### getFollowingDayOfWeek 메서드에 버그 수정
- 2004년 12월 25일이 토요일인 상태에서 getFollowingDayOfWeek 메서드를 호출하면 2005년 1월 1일 토요일이 나와야 하는데 2004년 12월 25일 토요일이 그대로 반환된다.
- 전형적인 경계 조건 오류다.
- if문에 >를 >=로 변경해주었다
#### testGetNearestDayOfWeek 수정
- getTestNearstDayOfWeek메서드를 테스트하는 testGetNearestDayOfWeek 단위 테스트는 처음부터 이렇게 길지 않았다.
- 처음 구현한 테스트 케이스가 실패하는 바람에 계속 추가하게 되었다.
- 주석으로 처리한 코드를 살펴보면 실패하는 패턴이 보인다.
- 알고리즘은 가장 가까운 날짜가 미래면 실패한다. 역시 경계 조건 오류다.
- weekInMonthToString과 relativeToString에서 오류 문자열을 반환하는 대신 IllegalArgumentException을 던져 테스트를 통과시켰다.

## 둘째, 고쳐보자
- 코드를 고칠 때마다 나는 JCommon 단위 테스트와 저자가 짠 단위 테스트를 실행했다.
- 라이선스 정보, 저작권, 작성자, 변경 이력중 법적인 정보는 보존하고 나머지는 1960년대에 나온 방식으로 삭제해준다.
- 지저분한 import문은 *을 이용해 정리해준다.
#### javadoc 주석 정리
- javadoc 주석은 HTML 태그를 사용한다. 한 소스 코드에 여러 언어를 사용하는게 탐탁치 않아 바꿀것이다.
- 이 주석은 네 가지 언어를 사용해 모양새를 맞추기 어렵다.
- 차라리 주석 전부를 pre태그로 감싸는 편이 좋다. 그러면 소스코드에 보이는 형식이 javadoc에 유지된다.
#### 클래스 이름이 SerialDate인 이유
- 클래스가 Serilizable에서 파생하니까? 아니다
- 정답은 일련번호를 사용해 클래스를 구현했기 때문이다.
- 여기서는 1899년 12월30일을 기준으로 경과한 날짜 수를 사용한다.
#### 두 가지 문제점
- 첫째 일련번호라는 용어는 정확 하지 못하다 상대 오프셋이 더 정확하다. 더 서술적인 용어로는 서수가 있다.
- 두번째는 SerialDate라는 이름의 추상화 수준이 올바르지 못하다고 생각한다. 그냥 Date가 더 좋아보인다.
- 하지만 이미 자바 라이브러리에는 Date라는 클래스가 너무 많다.
- 그러므로 Date가 최적이라 보기는 어렵다. 여러 모로 고민한 끝에 나는 DayDate를 사용하기로 했다.
#### MonthConstats를 enum으로 정의
- MonthConstants를 enum으로 변경함으로써 isValidMonthCode 메서드를 없앨수 있게 되었다.
- monthCodeToQuarter와 같은 오류 검사 코드 또한 필요 업ㅂㅅ어졌다.
#### serialVersionUID 살펴보기
- serialVersionUID변수는 직렬화를 제어한다.
- 이변수 값을 변경하면 이전 버전에서의 DayDate는 더 이상 인식이 안되어 복원하려 하면 InvalidClassException이 발생된다.
- serialVersionUID는 선언하지 않으면 컴파일러 에서 자동으로 생성한다.
- 문서에서는 직접 선언을 권하지만 저자는 자동 제어가 더 안전하다 판단하였다.
- 이유는 serialVersionUID를 변경하지 않아 괴상한 오류 만나느니 InvalidClassException 디버깅이 훨씬 쉽다고 생각하였기 떄문이다.
#### MINIMUM_YEAR_SUPPORTED, MAXIMUM_YEAR_SUPPORTED 수정
- DayDate는 추상 클래스라 구체적인 구현 정보를 포함할 필요가 없어 두 변수가 있을 이유도 없어 보인다.
- 그래서 두 변수를 SpreadsheetDate 클래스로 옮길 생각을 하였다. 하지만 다른 클래스도 두변수를 사용한다는 것에 막혔다.
- 이걸 해결하기 위해 DayDate 자체를 훼손하지 않으면서 구현 정보를 전달할 방법이 필요하다.
- 그래서 ABSTRACT FACTORY 패턴을 적용해 팩토리를 만들어 인스터스를 생성하였다.
#### 코드 정리
- 더이상 사용하지 않는 코드들 제거
- 변수 이름 다시 네이밍
- 의존성에 맞게 변수 및 메서드 위치 수정
- 설명이 부실한 주석 제거
- final 키워드 제거
- 복잡한 메서드 단순화 및 이름을 좀 더 서술적으로 변경
- 복잡한 알고리즘 단순화 및 임시 변수 설명을 통해 가독성 향상
- 중복된 인스턴스 메서드 제거
- 다소 복잡해 보이는 if문 연쇄 제거

## 작업 정리
1. 너무 오래된 주석 간단하게 고치고 개선
2. enum을 모두 독자적인 소스 파일로 변경
3. 정적변수와 정적메서드를 DateUil클래스로 이동
4. 일부 추상 메서드 DayDate클래스로 이동
5. Month.make를 Month.fromInt로 변경 다른 enum도 똑같이 변경 또한 모든 enum에 toInt()접근자 생성후 index필드 캡슐화
6. 중복 코드 새 메서드를 통해 중복 제거
7. 이곳저곳 사용 되던 숫자 1제거후 적절한 이름으로 다시 네이밍 및 알고리즘 손보기

## 결론
- DayDate코드 커버리지 84.9%로 감소. 테스트 하는 코드가 줄어서가 아닌 클래스가 줄어 테스트 하지 않는 비중이 커졌기에.
- 테스트 케이스는 53개중 45개를 테스트 하도록 변경.
- 다시 한번 우린 보이스카우트 규칙을 따랐다.
- 보이스카우트 규칙에 따름으로 다음 사람은 우리보다 코드를 좀 더 쉽게 이해할거고. 그래서 우리 보다 코드를 좀 더 쉽게 개선하리라.
